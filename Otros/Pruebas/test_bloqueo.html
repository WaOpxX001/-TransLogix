<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Test de Bloqueo - Abrir en Navegador</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-title {
            color: #2196f3;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .test-step {
            padding: 10px;
            margin: 10px 0;
            background: #f0f9ff;
            border-left: 4px solid #2196f3;
        }
        .code {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            margin: 10px 0;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #1976d2;
        }
        .result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
        }
        .error {
            background: #ffebee;
            border-left: 4px solid #f44336;
        }
        .warning {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
        }
    </style>
</head>
<body>
    <h1 style="text-align: center; color: #2196f3;">ğŸ” Test de Sistema de Bloqueo</h1>
    
    <div class="test-box">
        <div class="test-title">ğŸ“‹ Instrucciones</div>
        <div class="test-step">
            <strong>1.</strong> Abre la consola del navegador (F12)
        </div>
        <div class="test-step">
            <strong>2.</strong> Haz clic en los botones de prueba abajo
        </div>
        <div class="test-step">
            <strong>3.</strong> Revisa los resultados en esta pÃ¡gina y en la consola
        </div>
    </div>

    <div class="test-box">
        <div class="test-title">ğŸ§ª Prueba 1: Verificar Carga de Funciones</div>
        <button onclick="testFunciones()">Ejecutar Prueba 1</button>
        <div id="result1" class="result" style="display:none;"></div>
    </div>

    <div class="test-box">
        <div class="test-title">ğŸ§ª Prueba 2: Verificar API de VerificaciÃ³n</div>
        <p>Ingresa un ID de viaje para probar:</p>
        <input type="number" id="viajeId" placeholder="ID del viaje" value="1" style="padding: 8px; width: 200px; margin-right: 10px;">
        <button onclick="testAPI()">Ejecutar Prueba 2</button>
        <div id="result2" class="result" style="display:none;"></div>
    </div>

    <div class="test-box">
        <div class="test-title">ğŸ§ª Prueba 3: Verificar Usuario Actual</div>
        <button onclick="testUsuario()">Ejecutar Prueba 3</button>
        <div id="result3" class="result" style="display:none;"></div>
    </div>

    <div class="test-box">
        <div class="test-title">ğŸ§ª Prueba 4: Simular Carga de Solicitudes</div>
        <button onclick="testCargaSolicitudes()">Ejecutar Prueba 4</button>
        <div id="result4" class="result" style="display:none;"></div>
    </div>

    <div class="test-box">
        <div class="test-title">ğŸ’¡ Soluciones RÃ¡pidas</div>
        <button onclick="limpiarCache()">ğŸ—‘ï¸ Limpiar CachÃ© del Navegador</button>
        <button onclick="recargarPagina()">ğŸ”„ Recargar PÃ¡gina</button>
        <button onclick="abrirViajes()">ğŸ“‹ Ir a Viajes</button>
    </div>

    <script>
        function testFunciones() {
            const result = document.getElementById('result1');
            result.style.display = 'block';
            let output = 'ğŸ” VERIFICANDO FUNCIONES...\n\n';
            
            try {
                // Verificar si ViajesManager existe
                if (typeof window.ViajesManager !== 'undefined') {
                    output += 'âœ… window.ViajesManager existe\n';
                    
                    // Verificar funciones especÃ­ficas
                    const funciones = [
                        'tieneSolicitudPendienteSync',
                        'verificarBloqueoViaje',
                        'renderContadorBloqueo',
                        'renderBotonesAccion',
                        'cargarSolicitudesPendientes'
                    ];
                    
                    funciones.forEach(func => {
                        if (typeof window.ViajesManager[func] === 'function') {
                            output += `âœ… ${func} existe\n`;
                        } else {
                            output += `âŒ ${func} NO EXISTE\n`;
                        }
                    });
                    
                    result.className = 'result success';
                } else {
                    output += 'âŒ window.ViajesManager NO EXISTE\n';
                    output += '\nâš ï¸ SOLUCIÃ“N: Recarga la pÃ¡gina de viajes primero\n';
                    result.className = 'result error';
                }
            } catch (error) {
                output += 'âŒ ERROR: ' + error.message + '\n';
                result.className = 'result error';
            }
            
            result.textContent = output;
            console.log(output);
        }

        async function testAPI() {
            const result = document.getElementById('result2');
            result.style.display = 'block';
            const viajeId = document.getElementById('viajeId').value;
            let output = `ğŸ” PROBANDO API CON VIAJE ID: ${viajeId}\n\n`;
            
            try {
                // Obtener user_id del sessionStorage
                const userStr = sessionStorage.getItem('currentUser');
                let userId = null;
                
                if (userStr) {
                    const user = JSON.parse(userStr);
                    userId = user.id || user.user_id;
                    output += `âœ… Usuario encontrado: ID ${userId}\n\n`;
                } else {
                    output += `âš ï¸ No hay usuario en sessionStorage\n\n`;
                }
                
                // Hacer peticiÃ³n a la API
                const url = `/LogisticaFinal/api/viajes/verificar_solicitud.php?viaje_id=${viajeId}${userId ? `&user_id=${userId}` : ''}`;
                output += `ğŸ“¡ URL: ${url}\n\n`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                output += 'ğŸ“¥ RESPUESTA DE LA API:\n';
                output += JSON.stringify(data, null, 2) + '\n\n';
                
                if (data.success) {
                    if (data.bloqueado) {
                        output += `ğŸ”’ VIAJE BLOQUEADO\n`;
                        output += `   DÃ­as restantes: ${data.dias_restantes}\n`;
                        output += `   Motivo: ${data.motivo_rechazo}\n`;
                        result.className = 'result warning';
                    } else if (data.tiene_solicitud) {
                        output += `â³ SOLICITUD PENDIENTE\n`;
                        result.className = 'result warning';
                    } else {
                        output += `âœ… DISPONIBLE PARA SOLICITAR\n`;
                        result.className = 'result success';
                    }
                } else {
                    output += `âŒ ERROR: ${data.error}\n`;
                    result.className = 'result error';
                }
                
            } catch (error) {
                output += 'âŒ ERROR DE RED: ' + error.message + '\n';
                result.className = 'result error';
            }
            
            result.textContent = output;
            console.log(output);
        }

        function testUsuario() {
            const result = document.getElementById('result3');
            result.style.display = 'block';
            let output = 'ğŸ” VERIFICANDO USUARIO ACTUAL...\n\n';
            
            try {
                const userStr = sessionStorage.getItem('currentUser');
                
                if (userStr) {
                    const user = JSON.parse(userStr);
                    output += 'âœ… Usuario encontrado en sessionStorage:\n\n';
                    output += JSON.stringify(user, null, 2) + '\n\n';
                    
                    output += 'DATOS EXTRAÃDOS:\n';
                    output += `  ID: ${user.id || user.user_id || 'NO ENCONTRADO'}\n`;
                    output += `  Nombre: ${user.name || user.nombre || 'NO ENCONTRADO'}\n`;
                    output += `  Rol: ${user.role || user.user_role || 'NO ENCONTRADO'}\n`;
                    
                    result.className = 'result success';
                } else {
                    output += 'âŒ NO HAY USUARIO EN sessionStorage\n\n';
                    output += 'âš ï¸ SOLUCIÃ“N: Inicia sesiÃ³n primero\n';
                    result.className = 'result error';
                }
            } catch (error) {
                output += 'âŒ ERROR: ' + error.message + '\n';
                result.className = 'result error';
            }
            
            result.textContent = output;
            console.log(output);
        }

        async function testCargaSolicitudes() {
            const result = document.getElementById('result4');
            result.style.display = 'block';
            let output = 'ğŸ” SIMULANDO CARGA DE SOLICITUDES...\n\n';
            
            try {
                if (typeof window.ViajesManager === 'undefined') {
                    output += 'âŒ ViajesManager no existe\n';
                    output += 'âš ï¸ Abre la pÃ¡gina de viajes primero\n';
                    result.className = 'result error';
                    result.textContent = output;
                    return;
                }
                
                output += 'âœ… ViajesManager existe\n';
                output += `ğŸ“Š Viajes cargados: ${window.ViajesManager.viajes?.length || 0}\n\n`;
                
                if (window.ViajesManager.viajes && window.ViajesManager.viajes.length > 0) {
                    output += 'ğŸ”„ Ejecutando cargarSolicitudesPendientes()...\n\n';
                    
                    await window.ViajesManager.cargarSolicitudesPendientes();
                    
                    output += 'âœ… FunciÃ³n ejecutada\n';
                    output += `ğŸ“‹ Solicitudes cargadas: ${window.ViajesManager.solicitudesPendientes?.length || 0}\n\n`;
                    
                    if (window.ViajesManager.solicitudesPendientes && window.ViajesManager.solicitudesPendientes.length > 0) {
                        output += 'DETALLES:\n';
                        window.ViajesManager.solicitudesPendientes.forEach(s => {
                            output += `  Viaje ${s.viaje_id}: `;
                            if (s.bloqueado) {
                                output += `ğŸ”’ BLOQUEADO (${s.dias_restantes} dÃ­as)\n`;
                            } else if (s.tiene_solicitud) {
                                output += `â³ SOLICITUD PENDIENTE\n`;
                            } else {
                                output += `âœ… DISPONIBLE\n`;
                            }
                        });
                    }
                    
                    result.className = 'result success';
                } else {
                    output += 'âš ï¸ No hay viajes cargados\n';
                    result.className = 'result warning';
                }
                
            } catch (error) {
                output += 'âŒ ERROR: ' + error.message + '\n';
                output += '\nSTACK TRACE:\n' + error.stack;
                result.className = 'result error';
            }
            
            result.textContent = output;
            console.log(output);
        }

        function limpiarCache() {
            if (confirm('Â¿Limpiar cachÃ© y recargar?')) {
                // Limpiar localStorage y sessionStorage
                localStorage.clear();
                // NO limpiar sessionStorage para mantener la sesiÃ³n
                
                // Recargar con cachÃ© limpio
                location.reload(true);
            }
        }

        function recargarPagina() {
            location.reload(true);
        }

        function abrirViajes() {
            window.location.href = '/LogisticaFinal/index.html#viajes';
        }

        // Auto-ejecutar prueba 1 al cargar
        window.addEventListener('load', () => {
            console.log('ğŸ§ª PÃ¡gina de pruebas cargada');
            console.log('ğŸ“‹ Ejecuta las pruebas haciendo clic en los botones');
        });
    </script>
</body>
</html>
